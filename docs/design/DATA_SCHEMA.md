# Data Schema Specifications
## The Muscle & Strength Pyramid Training App

**Version:** 0.1
**Purpose:** Defines the core data models, relationships, and persistence structure for the application.
**Format:** TypeScript-like Interface Definitions (for clarity) + JSON Examples.

---

### 1. Core Enums & Types

These standardized types ensure consistency across the algorithm and UI.

```typescript
type MuscleGroup =
  | "Quads" | "Hamstrings" | "Glutes" | "Calves"
  | "Chest" | "Back_Lats" | "Back_Traps" | "Back_Lower"
  | "Delts_Front" | "Delts_Side" | "Delts_Rear"
  | "Biceps" | "Triceps" | "Abs";

type MovementPattern =
  | "Squat" | "Hinge" | "Lunge"
  | "Push_Horizontal" | "Push_Vertical"
  | "Pull_Horizontal" | "Pull_Vertical"
  | "Isolation";

type TrainingAge = "Novice" | "Intermediate" | "Advanced";

type Goal = "Strength" | "Hypertrophy";

type BlockPhase = "Accumulation" | "Intensification" | "Realization" | "Deload" | "Introductory";

// Level 6: Tempo
interface Tempo {
  eccentric: number; // seconds (e.g., 3 for "3-1-x-0")
  pause: number;     // seconds at the bottom (e.g., 1 for "3-1-x-0")
  concentric: number; // seconds (e.g., 0 for "3-1-x-0", 'x' for explosive)
  topPause?: number;  // optional, seconds at the top
}
```

---

### 2. User Profile (`user.json`)

Stores global settings and the "Onboarding" state.

```typescript
interface UserProfile {
  id: string;
  name: string;
  
  // Level 1: Adherence & Setup
  trainingAge: TrainingAge;
  goal: Goal;
  availableDays: number[]; // e.g., [1, 3, 5] for Mon, Wed, Fri
  
  // Level 4: Exercise Selection
  weakPoints: MuscleGroup[]; // Prioritized in sort order
  excludedExercises: string[]; // IDs of exercises to never suggest (injuries)
  
  // Settings
  unit: "lbs" | "kg";
  minPlateIncrement: number; // e.g., 2.5 or 5.0
  onboardingCompleted: boolean;
  
  // Advanced overrides
  progressionOverrides: Record<string, "Novice" | "Intermediate" | "DoubleProgression">;
  
  // Fundamentals for Assessment
  fundamentalsStatus?: FundamentalsStatus;
}

interface FundamentalsStatus {
  averageSleepHours?: number;    // self-reported or periodically input
  proteinIntakeQuality?: "poor" | "ok" | "good"; // e.g., "poor", "ok", "good"
  stressLevel?: "low" | "moderate" | "high";         // e.g., "low", "moderate", "high"
  notes?: string;               // free text, optional
}
```

---

### 3. Exercise Database (`exercise_db.json`)

The static library of available movements.

```typescript
interface MuscleImpact {
  muscle: MuscleGroup;
  factor: number; // 1.0 = Direct, 0.5 = Indirect
}

interface Exercise {
  id: string;
  name: string;
  
  // Level 4: Classification
  pattern: MovementPattern;
  type: "Compound" | "Isolation" | "Machine";
  equipment: "Barbell" | "Dumbbell" | "Machine" | "Cable" | "Bodyweight";
  
  // Level 1: Volume Logic
  primaryMuscle: MuscleGroup;
  secondaryMuscles: MuscleImpact[];
  
  // Level 6: Tempo
  defaultTempo: string; // e.g., "3-0-x-0"
  
  // Substitution logic
  tier: "Tier1" | "Tier2" | "Tier3"; // Tier1 = Competition Lifts
  isCompetitionLift: boolean;
  isUserCreated: boolean; // true for user-created, false for built-in
}
```

---

### 4. Active Program State (`program_state.json`)

The "Brain" of the app. It tracks where the user is in the Pyramid cycles.

```typescript
interface ProgressionState {
  exerciseId: string;
  
  // Novice Logic
  currentLoad: number;
  consecutiveFails: number; // Counts failed sessions (Renamed from stallCounter)
  resetCount: number; // Counts -10% resets
  
  // Validation
  recentRPEs: number[]; // Last 3 session RPEs for consistency check
  
  // Intermediate/Advanced Logic
  baseLoad: number; // The "anchor" load for the current wave
  
  // Double Progression (Accessory)
  currentRepTarget: number; // Bottom or Top of range?
}

interface ActiveProgram {
  id: string;
  startDate: string; // ISO Date
  
  // Level 3: Periodization
  currentBlockPhase: BlockPhase;
  currentWeek: number; // 1-4 usually
  consecutiveBlocksWithoutDeload: number; // For mandatory check
  
  // Level 1: Schedule
  // The template for the current week (Generated by Algo)
  weeklySchedule: ScheduledSession[]; 
  
  // State tracking
  progressionData: Record<string, ProgressionState>; // Keyed by ExerciseID
}

interface ScheduledSession {
  dayOfWeek: number; // 1=Mon
  name: string; // "Upper Power"
  exercises: ScheduledExercise[];
}

interface ScheduledExercise {
  exerciseId: string;
  order: number;
  
  // Calculated Targets (from Progression Engine)
  targetSets: number;
  targetReps: number; // or Range [8, 12]
  targetLoad: number;
  targetRPE: number;
  targetTempoOverride?: Tempo; // If user or program defines a non-default tempo
  
  // Context
  note: string; // "Pause at bottom"
  isWeakPointPriority: boolean;
}
```

---

### 5. Workout History (`workout_logs.json`)

The immutable record of "What actually happened".

```typescript
interface CompletedSet {
  setNumber: number;
  
  // Targets (Snapshot)
  targetLoad: number;
  targetReps: number;
  
  // Actuals
  load: number;
  reps: number;
  rpe: number; // 1.0 - 10.0
  tags: ("Warmup" | "APS" | "DropSet" | "RestPause")[]; // NEW: rest-pause sets
  actualTempo?: Tempo; // Optional, if user records it or app infers
}

interface CompletedExercise {
  exerciseId: string;
  sets: CompletedSet[];
  
  // Substitution Tracking
  wasSwapped: boolean;
  originalExerciseId?: string;
}

interface WorkoutLog {
  id: string;
  programId: string;
  
  // Timestamps
  dateScheduled: string;
  dateCompleted: string;
  durationMinutes: number;
  
  // Adherence (Level 1)
  status: "Completed" | "Skipped" | "Combined";
  mode: "normal" | "shortOnTime"; // APS / time-constrained mode
  notes: string;
  
  // Execution (Level 2)
  exercises: CompletedExercise[];
  
  // Level 5: Fatigue Feedback (Post-Session)
  sessionRPE: number; // 1-10 global rating
  wellnessScore: number; // 1-5 (used for Deload decisions)
  checklistScore?: number; // Result of Post-Block Assessment (0-4)
}

// Note: When APS / short-on-time mode is active, some scheduled accessory sets may be omitted
// completely from `CompletedSet` within `WorkoutLog.exercises`. This is interpreted by the
// analytics as volume reduction for that session.

```

---

### 6. JSON Example: Valid Volume Calculation

This structure supports the algorithm's "Volume Equator" visualization.

```json
{
  "volume_snapshot_week_1": {
    "Quads": {
      "direct_sets": 8.0,
      "indirect_sets": 3.0, 
      "total": 11.0,
      "status": "Optimal"
    },
    "Biceps": {
      "direct_sets": 0.0,
      "indirect_sets": 6.0, // From Rows/Pulldowns
      "total": 6.0,
      "status": "Under-dosed" 
    }
  }
}
```

---

### 7. Analytics-related Structures (Optional Cached Data)
These are derived from `WorkoutLog` and `ActiveProgram` and are **optional cached data**, not primary data. They can be recomputed if needed.

```typescript
interface AnalyticsSnapshot {
  liftId: string;                // e.g., "squat", "bench", or exerciseId of main lift
  e1RMHistory: E1RMPoint[];      // time series of estimated 1RM
  rpeDistribution: RPERangeBin[]; // aggregated RPE counts or percentages for recent weeks
  blockPhaseSegments: BlockPhaseSegment[]; // for timeline labeling
  lastUpdatedAt: string;         // ISO Date string
}

interface E1RMPoint {
  date: string; // ISO Date string
  e1rm: number;
}

interface RPERangeBin {
  rangeLabel: string;     // e.g., "6-7", "7.5-8.5", "9-10"
  count: number;             // number of working sets in this range over a period
  periodWeeks: number;       // number of weeks considered (e.g., 4)
}

interface BlockPhaseSegment {
  startDate: string; // ISO Date string
  endDate: string;   // ISO Date string
  phase: string;          // e.g., "Accumulation", "Intensification", "Realization", "Intro"
}
```

---

### 8. Exported Data Formats
This section describes the structure of data when exported by the user.

*   **JSON Export:**
    *   Direct dump of the application's internal data models:
        *   `UserProfile`
        *   `ActiveProgram`
        *   `WorkoutLog` (all entries, including `CompletedSet` details)
        *   `Exercise` (both built-in and user-created)
*   **CSV Export (Example):**
    *   One row per completed set, with the following fields:
        *   `date`, `exerciseId`, `exerciseName`, `muscleGroup`, `setIndex`, `targetReps`, `actualReps`, `targetLoad`, `actualLoad`, `rpe`, `tags`, `sessionId`, `blockPhase`, `blockWeek`, etc.

